#!/bin/sh

# Source the INSTALL_DIRECTORY variable
[ -f ~/profile ] && . ~/profile

# Do this in the postinstall hook because PORT_WWW is not the environment
# during build time.
echo "Generating dotCloud scaffolding..."
cat > ~/run <<EOF
#!/bin/bash
sed -i 's/^org.neo4j.server.webserver.port=.*//' $INSTALL_DIRECTORY/conf/neo4j-server.properties
sed -i 's/^org.neo4j.server.webserver.address=.*//' $INSTALL_DIRECTORY/conf/neo4j-server.properties
echo org.neo4j.server.webserver.port=$PORT_WWW >> $INSTALL_DIRECTORY/conf/neo4j-server.properties
echo org.neo4j.server.webserver.address=0.0.0.0 >> $INSTALL_DIRECTORY/conf/neo4j-server.properties

# Alright, this is downright ugly, but it (should) work.
exec /usr/bin/java -cp $INSTALL_DIRECTORY/lib/geronimo-jta_1.1_spec-1.1.1.jar:$INSTALL_DIRECTORY/lib/lucene-core-3.1.0.jar:$INSTALL_DIRECTORY/lib/$INSTALL_DIRECTORY.jar:$INSTALL_DIRECTORY/lib/neo4j-cypher-1.5.M02.jar:$INSTALL_DIRECTORY/lib/neo4j-graph-algo-1.5.M02.jar:$INSTALL_DIRECTORY/lib/neo4j-graph-matching-1.5.M02.jar:$INSTALL_DIRECTORY/lib/neo4j-jmx-1.5.M02.jar:$INSTALL_DIRECTORY/lib/neo4j-kernel-1.5.M02.jar:$INSTALL_DIRECTORY/lib/neo4j-lucene-index-1.5.M02.jar:$INSTALL_DIRECTORY/lib/neo4j-shell-1.5.M02.jar:$INSTALL_DIRECTORY/lib/neo4j-udc-1.5.M02.jar:$INSTALL_DIRECTORY/lib/org.apache.servicemix.bundles.jline-0.9.94_1.jar:$INSTALL_DIRECTORY/lib/scala-library-2.9.0-1.jar:$INSTALL_DIRECTORY/lib/server-api-1.5.M02.jar:$INSTALL_DIRECTORY/system/lib/antlr-2.7.7.jar:$INSTALL_DIRECTORY/system/lib/asm-3.1.jar:$INSTALL_DIRECTORY/system/lib/asm-analysis-3.2.jar:$INSTALL_DIRECTORY/system/lib/asm-commons-3.2.jar:$INSTALL_DIRECTORY/system/lib/asm-tree-3.2.jar:$INSTALL_DIRECTORY/system/lib/asm-util-3.2.jar:$INSTALL_DIRECTORY/system/lib/avalon-framework-api-4.3.1.jar:$INSTALL_DIRECTORY/system/lib/avalon-framework-impl-4.3.1.jar:$INSTALL_DIRECTORY/system/lib/batik-anim-1.7.jar:$INSTALL_DIRECTORY/system/lib/batik-awt-util-1.7.jar:$INSTALL_DIRECTORY/system/lib/batik-bridge-1.7.jar:$INSTALL_DIRECTORY/system/lib/batik-css-1.7.jar:$INSTALL_DIRECTORY/system/lib/batik-dom-1.7.jar:$INSTALL_DIRECTORY/system/lib/batik-ext-1.7.jar:$INSTALL_DIRECTORY/system/lib/batik-extension-1.7.jar:$INSTALL_DIRECTORY/system/lib/batik-gvt-1.7.jar:$INSTALL_DIRECTORY/system/lib/batik-parser-1.7.jar:$INSTALL_DIRECTORY/system/lib/batik-script-1.7.jar:$INSTALL_DIRECTORY/system/lib/batik-svg-dom-1.7.jar:$INSTALL_DIRECTORY/system/lib/batik-svggen-1.7.jar:$INSTALL_DIRECTORY/system/lib/batik-transcoder-1.7.jar:$INSTALL_DIRECTORY/system/lib/batik-util-1.7.jar:$INSTALL_DIRECTORY/system/lib/batik-xml-1.7.jar:$INSTALL_DIRECTORY/system/lib/blueprints-core-1.0.jar:$INSTALL_DIRECTORY/system/lib/blueprints-neo4j-graph-1.0.jar:$INSTALL_DIRECTORY/system/lib/commons-beanutils-1.8.0.jar:$INSTALL_DIRECTORY/system/lib/commons-beanutils-core-1.8.0.jar:$INSTALL_DIRECTORY/system/lib/commons-collections-3.2.1.jar:$INSTALL_DIRECTORY/system/lib/commons-configuration-1.6.jar:$INSTALL_DIRECTORY/system/lib/commons-digester-1.8.1.jar:$INSTALL_DIRECTORY/system/lib/commons-io-1.4.jar:$INSTALL_DIRECTORY/system/lib/commons-lang-2.4.jar:$INSTALL_DIRECTORY/system/lib/commons-logging-1.1.1.jar:$INSTALL_DIRECTORY/system/lib/fop-1.0.jar:$INSTALL_DIRECTORY/system/lib/gremlin-1.3.jar:$INSTALL_DIRECTORY/system/lib/groovy-1.8.2.jar:$INSTALL_DIRECTORY/system/lib/jackson-core-asl-1.8.3.jar:$INSTALL_DIRECTORY/system/lib/jackson-jaxrs-1.8.3.jar:$INSTALL_DIRECTORY/system/lib/jackson-mapper-asl-1.8.3.jar:$INSTALL_DIRECTORY/system/lib/jansi-1.5.jar:$INSTALL_DIRECTORY/system/lib/jcl-over-slf4j-1.6.1.jar:$INSTALL_DIRECTORY/system/lib/jersey-core-1.9.jar:$INSTALL_DIRECTORY/system/lib/jersey-multipart-1.9.jar:$INSTALL_DIRECTORY/system/lib/jersey-server-1.9.jar:$INSTALL_DIRECTORY/system/lib/jettison-1.3.jar:$INSTALL_DIRECTORY/system/lib/jetty-6.1.25.jar:$INSTALL_DIRECTORY/system/lib/jetty-util-6.1.25.jar:$INSTALL_DIRECTORY/system/lib/jsr311-api-1.1.1.jar:$INSTALL_DIRECTORY/system/lib/log4j-over-slf4j-1.6.1.jar:$INSTALL_DIRECTORY/system/lib/mimepull-1.6.jar:$INSTALL_DIRECTORY/system/lib/neo4j-cypher-plugin-1.5.M02.jar:$INSTALL_DIRECTORY/system/lib/neo4j-gremlin-plugin-1.5.M02.jar:$INSTALL_DIRECTORY/system/lib/neo4j-server-1.5.M02.jar:$INSTALL_DIRECTORY/system/lib/neo4j-server-1.5.M02-static-web.jar:$INSTALL_DIRECTORY/system/lib/pipes-0.8.jar:$INSTALL_DIRECTORY/system/lib/rrd4j-2.0.7.jar:$INSTALL_DIRECTORY/system/lib/servlet-api-2.5-20081211.jar:$INSTALL_DIRECTORY/system/lib/slf4j-api-1.6.1.jar:$INSTALL_DIRECTORY/system/lib/slf4j-jdk14-1.6.1.jar:$INSTALL_DIRECTORY/system/lib/stax-api-1.0.1.jar:$INSTALL_DIRECTORY/system/lib/xalan-2.6.0.jar:$INSTALL_DIRECTORY/system/lib/xml-apis-1.3.04.jar:$INSTALL_DIRECTORY/system/lib/xml-apis-ext-1.3.04.jar:$INSTALL_DIRECTORY/system/lib/xmlgraphics-commons-1.4.jar -server -XX:+DisableExplicitGC -Dorg.neo4j.server.properties=conf/neo4j-server.properties -Djava.util.logging.config.file=conf/logging.properties -Xms3m -Xmx64m -Dlog4j.configuration=file:conf/log4j.properties -Dorg.neo4j.server.properties=$INSTALL_DIRECTORY/conf/neo4j-server.properties -Djava.util.logging.config.file=$INSTALL_DIRECTORY/conf/logging.properties -Dneo4j.home=$INSTALL_DIRECTORY -Dneo4j.instance=$INSTALL_DIRECTORY org.neo4j.server.Bootstrapper
EOF
chmod +x ~/run
